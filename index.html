<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="test.css">
    <link href="https://fonts.cdnfonts.com/css/ds-digital" rel="stylesheet">
    <title>Real-Time Counter</title>
    <link rel="icon" type="image/jpg" href="Images/Logo.jpg">
</head>
<body class="body">
    <div class="container3">
        <h1 class="counterBox">Count: <span class="counter">0</span></h1>

        <div class="container1">
            <div class="container2">
                <input type="button" value="Click Me" class="button" title="Click Me">
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="Action.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js"></script>

    <!-- Firebase Firestore and Counter Logic -->
    <script type="module">
        // Import Firebase libraries
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA2axhnlDhVTv5ac5GUpX99rgQQoj0-uXw",
            authDomain: "techtitive-counter.firebaseapp.com",
            projectId: "techtitive-counter",
            storageBucket: "techtitive-counter.firebasestorage.app",
            messagingSenderId: "374532775348",
            appId: "1:374532775348:web:337ceaa95f051eebd066e1",
            measurementId: "G-0C5VJE3VPW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Firestore reference
        const counterRef = doc(db, 'clickData', 'counter');

        // HTML element references
        const clicktarget = document.querySelector('.button');
        const counter = document.querySelector('.counter');

        // Initialize local storage and UI
        let clickcount = localStorage.getItem('clickcount') || 0; // Get from local storage
        clickcount = Number(clickcount);
        counter.textContent = clickcount; // Update UI with local storage value

        // Fetch Firestore value on page load and sync with local storage
        getDoc(counterRef).then((docSnapshot) => {
            if (docSnapshot.exists()) {
                const firestoreCount = docSnapshot.data().count || 0;
                // Update local storage if Firestore value is greater
                if (firestoreCount > clickcount) {
                    clickcount = firestoreCount;
                    localStorage.setItem('clickcount', clickcount);
                    counter.textContent = clickcount;
                }
            } else {
                // Initialize Firestore document if it doesn't exist
                setDoc(counterRef, { count: clickcount });
            }
        });

        // Real-time listener for updates from Firestore
        onSnapshot(counterRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const firestoreCount = docSnapshot.data().count || 0;
                if (firestoreCount !== clickcount) {
                    clickcount = firestoreCount;
                    localStorage.setItem('clickcount', clickcount);
                    counter.textContent = clickcount;
                }
            }
        });

        // Button click event
        clicktarget.addEventListener('click', async () => {
            // Update local storage immediately
            clickcount++;
            localStorage.setItem('clickcount', clickcount);
            counter.textContent = clickcount;

            try {
                // Sync with Firestore
                await updateDoc(counterRef, { count: clickcount });
            } catch (error) {
                console.error("Error updating Firestore:", error);
            }
        });
    </script>
</body>
</html>
